# 動画圧縮ツール - 音質・画質モード選択対応版

[English](README.md) | [中文](README_zh.md)  | [한국어](README_ko.md) | [ไทย](README_th.md)

macOS用の動画圧縮CLIツール。目標ファイルサイズを指定して、画質モード（音質優先/画質優先/バランス）を選択しながら動画を圧縮できます。

## 特徴

- **目標サイズを正確に指定**: MB単位で目標サイズを指定可能(小数点可)
- **画質モード選択**: 音質優先、画質優先、バランスから選択
  - 音質優先(192kbps): 音楽、講演、ASMR向け
  - 画質優先(128kbps): アニメ、映画、ゲーム実況向け
  - バランス(160kbps): 一般的な動画向け
- **リアルタイム進捗表示**: プログレスバーと残り時間を表示
- **2パスエンコーディング**: 高品質な圧縮を実現
- **バッチ処理対応**: ディレクトリ内の全動画を一括処理
- **ドライランモード**: 実際の圧縮前に結果をプレビュー
- **処理履歴ログ**: `~/.video-compressor/history.log` に自動保存
- **拡張子変換対応**: MP4, MOV, AVI, MKV, WebM, FLV
- **わかりやすいエラー表示**: 想定されるエラーを明確に通知

## 必須要件

- macOS
- Python 3.8以上
- ffmpeg

## インストール

### 1. ffmpegのインストール

```bash
brew install ffmpeg
```

### 2. スクリプトのダウンロード

```bash
# GitHubからクローン
git clone https://github.com/hiroki-abe-58/video-compressor.git
cd video-compressor

# または、直接ダウンロード
curl -O https://raw.githubusercontent.com/hiroki-abe-58/video-compressor/main/compress_video.py
chmod +x compress_video.py
```

### 3. 実行権限付与

```bash
chmod +x compress_video.py
```

## 使い方

### 基本的な使い方

```bash
python3 compress_video.py
```

または:

```bash
./compress_video.py
```

### コマンドラインオプション

```bash
# 通常モード
./compress_video.py

# ドライランモード(実際の圧縮はせずプレビューのみ)
./compress_video.py --dry-run

# バージョン表示
./compress_video.py --version

# ヘルプ表示
./compress_video.py --help
```

### 実行フロー

#### フェーズ1: 動画パス入力
```
動画ファイルまたはディレクトリのパスを入力し、エンターを押してください:
> /path/to/video.mp4
```

**ヒント**: ファインダーからドラッグ&ドロップでもOK

#### フェーズ2: 目標サイズ入力
```
ファイル名: video.mp4
現在のファイル容量: 150.50 MB
動画の長さ: 00:05:30

この動画を何MBまで圧縮しますか？数字を入力しエンターを押してください。(小数点可):
> 50
```

#### フェーズ2.5: 画質モード選択
```
【フェーズ2.5】画質モード選択
どのモードで圧縮しますか？

  1. 音質優先 (音声192kbps)
     音楽、講演、ASMR などの音が重要なコンテンツ向け

  2. 画質優先 (音声128kbps)
     アニメ、映画、ゲーム実況 などの映像が重要なコンテンツ向け

  3. バランス (音声160kbps)
     一般的な動画向け。音質と画質のバランスが取れた設定

番号を選択してください (デフォルト: 1):
```

#### フェーズ3: 拡張子変換(オプション)
```
拡張子は変換しますか？ (y/何も入力せずEnter):
> y

変換可能な形式:
  1. MP4 (H.264)
  2. MOV (QuickTime)
  3. AVI
  4. MKV (Matroska)
  5. WebM
  6. FLV (Flash Video)

番号を選択してください: 1
```

#### フェーズ4: 圧縮実行
```
[1/2] 1パス目: ビットレート解析中...
1パス目: [████████████████████░░░░░░░░░░░░░░░░░░░░]  48.5% | 残り時間: 00:02:15

[2/2] 2パス目: 最終エンコード中...
2パス目: [████████████████████████████████████████] 100.0% | 残り時間: 00:00:00
```

#### フェーズ5: 完了
```
圧縮が完了し、圧縮した動画ファイルは保存されました!
============================================================
画質モード: 画質優先
ファイル名: video--compressed--50.0MB--2025-11-03-15-30-45.mp4
保存先: /path/to/video--compressed--50.0MB--2025-11-03-15-30-45.mp4
目標サイズ: 50.00 MB
実際のサイズ: 49.85 MB
差分: 0.15 MB
圧縮率: 66.9%
処理時間: 00:10:21
============================================================

処理履歴は ~/.video-compressor/history.log に保存されています。

もう1本圧縮する？ (y/n):
```

## 画質モード

### 目標50MBでの比較（5分の1080p動画の場合）

| モード | ビデオビットレート | 音声ビットレート | 適した用途 |
|--------|-------------------|-----------------|-----------|
| 音質優先 | 1145 kbps | 192 kbps | 音楽動画、コンサート、講演、ASMR |
| バランス | 1241 kbps | 160 kbps | Vlog、チュートリアル、一般的なコンテンツ |
| 画質優先 | 1337 kbps | 128 kbps | アニメ、映画、ゲーム実況、アクション動画 |

**画質優先モードは音質優先モードと比べて、ビデオに17%多くのビットレートを割り当てます！**

### 各モードの使い分け

**音質優先**
- 音楽のライブパフォーマンスやコンサート
- 講演やプレゼンテーション
- ASMRコンテンツ
- 動画付きポッドキャスト
- 音質が重要なあらゆるコンテンツ

**画質優先**
- アニメーション作品
- 映画やドラマ
- ゲームプレイ動画やウォークスルー
- 複雑な動きのあるアクション動画
- 視覚効果のデモンストレーション

**バランス**
- Vlogや個人的な動画
- チュートリアルやハウツー動画
- インタビュー
- 汎用目的の動画
- 音声と映像が同程度に重要な場合

## ドライランモード

実際の圧縮を行わず、結果をプレビューできます:

```bash
./compress_video.py --dry-run
```

**出力例**:
```
ドライラン結果
============================================================
入力ファイル: video.mp4
現在のサイズ: 150.50 MB
目標サイズ: 50.00 MB
圧縮率: 66.8%
動画の長さ: 00:05:30

【画質モード】
  画質優先: 画質を優先し、音声を最低限に抑える

【エンコード設定】
  ビデオビットレート: 1337 kbps
  音声ビットレート: 128 kbps (AAC)
  コーデック: H.264 (libx264)

【予想画質】
  高画質 (軽微な劣化)

【出力ファイル】
  ファイル名: video--compressed--50.0MB--2025-11-03-15-30-45.mp4
  保存先: /path/to/video--compressed--50.0MB--2025-11-03-15-30-45.mp4
============================================================

実際に圧縮する場合は --dry-run オプションを外して実行してください。
```

## バッチ処理

ディレクトリ内の全動画ファイルを一括処理:

```bash
./compress_video.py

# ディレクトリパスを入力
> /Users/username/Videos/batch-compress/

# 5個の動画ファイルが見つかりました:
#   1. video1.mp4 (150.50 MB)
#   2. video2.mov (200.30 MB)
#   ...

# 設定方法を選択してください:
#   1. 一括設定 (全てのファイルに同じ設定を適用)
#   2. 個別設定 (ファイルごとに設定)
```

## 処理履歴

全ての処理は `~/.video-compressor/history.log` に自動記録されます

### ログの確認方法

```bash
# 全てのログを表示
cat ~/.video-compressor/history.log

# 最新のログのみ表示
tail -n 20 ~/.video-compressor/history.log

# リアルタイムでログを監視
tail -f ~/.video-compressor/history.log

# エラーのみ検索
grep ERROR ~/.video-compressor/history.log
```

### ログ形式

```
YYYY-MM-DD HH:MM:SS - LEVEL - メッセージ

例:
2025-11-03 15:30:45 - INFO - 動画圧縮ツール v1.4.0 起動
2025-11-03 15:30:50 - INFO - 画質モード選択: 画質優先
2025-11-03 15:31:02 - INFO - 圧縮開始: video.mp4, モード: 画質優先, 現在サイズ: 150.50MB, 目標サイズ: 50.00MB, ビデオビットレート: 1337kbps, 音声ビットレート: 128kbps
2025-11-03 15:41:23 - INFO - 圧縮完了: video.mp4 -> video--compressed--50.0MB--2025-11-03-15-31-02.mp4, モード: 画質優先, 現在サイズ: 150.50MB, 目標サイズ: 50.00MB, 実際サイズ: 49.85MB, 差分: 0.15MB, 圧縮率: 66.9%, 処理時間: 00:10:21
```

## 出力ファイル名の形式

```
[元ファイル名]--compressed--[目標サイズ]MB--[yyyy-mm-dd-hh-mm-ss].[拡張子]
```

例:
```
my_video--compressed--50.0MB--2025-11-03-15-30-45.mp4
```

## エラーハンドリング

このツールは以下のエラーを検出して、わかりやすく表示します:

- ffmpegが未インストール
- ファイルが存在しない
- サポートされていないファイル形式
- 目標サイズが現在のサイズより大きい
- 目標サイズが小さすぎる(音声だけで容量オーバー)
- 無効な入力値(数字以外など)
- エンコード中のエラー

## 技術詳細

### 圧縮アルゴリズム

1. **動画の長さを取得** (ffprobe使用)
2. **画質モードを選択** (音質優先/画質優先/バランス)
3. **目標サイズから必要なビデオビットレートを逆算**
   ```
   ビデオビットレート = (目標サイズ - 音声サイズ) / 動画の長さ * 0.95
   ```
4. **2パスエンコーディングで高品質圧縮**
   - 1パス目: ビットレート配分を解析
   - 2パス目: 最適化されたエンコーディング

### サポートファイル形式

**入力**: `.mp4`, `.avi`, `.mov`, `.mkv`, `.flv`, `.wmv`, `.webm`, `.m4v`, `.mpeg`, `.mpg`

**出力**: `.mp4`, `.mov`, `.avi`, `.mkv`, `.webm`, `.flv`

## トラブルシューティング

### ffmpegが見つからない
```bash
brew install ffmpeg
```

### 圧縮に時間がかかりすぎる
- 2パスエンコーディングは時間がかかる(1パス目+2パス目)
- 長い動画だと数十分かかることもある
- プログレスバーで進捗確認できる

### 目標サイズとずれる
- ±5%程度の誤差は正常
- より正確にしたい場合は、目標サイズを少し小さめに設定

### エンコードが失敗する
- ディスク容量を確認
- 動画ファイルが壊れていないか確認
- 別の拡張子で試す

## バージョン履歴

### v1.4.0
- 画質モード選択機能を追加（音質優先/画質優先/バランス）
- ログに画質モード情報を追加

### v1.3.0
- 処理履歴ログ機能を追加
- ログローテーション対応（10MB、5世代）

### v1.2.0
- ドライランモードを追加
- 画質レベル推定機能を追加

### v1.1.0
- バッチ処理機能を追加
- ディレクトリ入力対応

### v1.0.0
- 初期リリース
- 音質優先での基本的な圧縮機能

## ライセンス

MIT License

## 作者

[hiroki-abe-58](https://github.com/hiroki-abe-58)

## 謝辞

参考: https://note.com/genelab_999/n/n5db5c3a80793
